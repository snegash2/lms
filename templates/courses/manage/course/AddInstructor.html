{% extends '_base.html' %}
{% load static %}
{% load crispy_forms_tags %}

    {% block title %} {{request.user.username }} add course{% endblock %}

    {% block style %}
    
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" href="{% static 'logo.png' %}" type="image/x-icon" />
        <link rel="stylesheet" href="{% static 'instructor_course_add.css' %}" />
        <link rel="stylesheet" href="{% static 'instructor_course_add_footer.css'%} " />
        <link rel="stylesheet" href="{% static 'instructor_course_add_css.css' %}" />
        <link rel="stylesheet" href="{% static 'instructor_course_add_main.css'%}" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">



    {% endblock %}
  
 {% block content %}
    <!-- start -->
    <div class="main__container" id="mainContainer">
      <div class="first">
        <img src="{% static 'back.png' %}" alt="" />
      </div>
      <div class="second">
        <h1>Course guidelines</h1>
        <hr />

    

        <div style="display: flex;flex-direction:column;">

          <div >
            <label for="categorySelect">Select Category:</label>
            <select id="categorySelect" onchange="populateCourses()">
              <option value="">Select...</option>
              {% for category in categories %}
                <option value="{{category}}" id="{{category}}">{{category|title}}</option>
              {% endfor %}
    
            </select>
          </div>

          <div style="display: flex; flex-direction:row;width:100%;margin-top:20px;">
            <label for="courseSelect" style="margin-right:30px;height:10px;margin-top:20px;">Select Course:</label>
            <select id="courseSelect" onchange="showCourseModal()">
              <!-- Courses will be populated dynamically using JavaScript -->
            </select>
          </div>
       
  
      
        </div>
    
      </div>
    </div>
    <!-- Modal -->

    <!-- Modal -->
        <div id="myModal">
          <div id="error-container"></div>
          <div class="modal-content" style="max-width:80vh; max-height: 80vh; overflow-y: auto;;">
            <span id="closeModal" onclick="closeModal()">&times;</span>
            <h2>Course Information</h2>
            <!-- Wrapping the course description section for horizontal scrolling -->
            <div class="scrollable-section" style="overflow-x: auto">
              
              <div class="popup-field">
                <label for="courseName">Course Name:</label>
                <input type="text" id="courseName" readonly />
                  <script>
                   
                  </script>
                <i
                  class="icon fas fa-pencil-alt"
                  onclick="enableEdit('courseName')"
                ></i>
              </div>
              <form method="post" action="." id="course-form" enctype="multipart/form-data">   
                {% csrf_token %}
                <div id="myerror"></div>
                {{form|crispy}}

                  <input type="hidden" name="subCategory" value="{{courseName}}" />
                  <input type="hidden" name="category" value="{{category}}" />

              
                    <div class="popup-field">
                      <label for="courseDescription"></label>
                      <div
                        id="courseDescription"
                        rows="4"
                        cols="50"
                  
                      ></div
                      <i
                        class="icon fas fa-pencil-alt"
                        onclick="enableEdit('courseDescription')"
                      ></i>
                    </div>
                  </div>
          
                  <br/>

                  <button type="submit" class="buttons" >Save</button>
                
          </form>
          </div>
        </div>
    <!-- Container for displaying saved courses -->
    <div id="coursesContainer">

      {% for course in mycourses %}

        
        <!-- Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Delete {{course.name|title}}</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                Are you sure you want to delete this course?
              </div>
              <div class="modal-footer">
                <button type="button" id="modal-delete-btn" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" onclick = "deleteId({{course.id}})">Delete</button>
              </div>
            </div>
          </div>
        </div>


        <div class="courseCard" id="course_{{course.id}}" >
          <button type="button" class="btn btn-primary position-relative">
            Status
          {% if course.published%}
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                <small>Accepted</small>
              <span class="visually-hidden">unread messages</span>
            </span>

            {% else %}

            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
              <small>Waiting</small>
              <span class="visually-hidden">unread messages</span>
            </span>
            {% endif %}
          </button>
          <img src="{{course.image.url}}" alt="{{course.name}}" class="courseImage" style="width: 300px;height:150px;" />
          <h3>{{course.name|title}}</h3>
          <p class="courseDescription" style="margin: auto;"> {{course.overview|safe|truncatechars:80}}</p>
         
          <div class="editDeleteButtons">
          
              <a href="{% url 'courses:course_edit' course.id %}">
                <button  class="addModuleButton" type="button">View Course</button>
              </a>
                 
                 
              <a href="{% url "courses:egiliablity" course.id %}">
                <button  class="addModuleButton" >Students</button>
              </a>
    
          
              <a href="{% url "courses:course_module_update" course.id %}">
                <button class="addModuleButton">Add Module</button>
              </a>
              <a>
                <button type="button" class="btn btn-secondary addModuleButton" style="background-color: brown;" id="delete-btn" onclick="deleteAction({{course.id}})" data-bs-toggle="modal" style="float:inline-end;margin-top:5px;margin-left:5px;margin-right:60px;height:60px;border-radius:5px;"data-bs-target="#exampleModal">Delete  &nbsp; &nbsp;</button>

              </a>

          </div>
        </div>

        {% endfor %}
    </div>
 <script>

  function scrollToDown() {
  let scrollPosition = window.scrollY;
  let height = document.body.scrollHeight;
  let steps = Math.ceil(height / 50); // Adjust steps based on desired scroll speed
  let interval = setInterval(() => {
    if (scrollPosition < height) {
      scrollPosition += Math.ceil(height / steps);
      window.scrollBy(0, scrollPosition - window.scrollY);
    } else {
      clearInterval(interval);
    }
  }, 60); // Adjust interval for desired smoothness

  }
  function deleteAction(courseId) {

  }


  function deleteId(id) {
    const data = {
      "pk":id
    }
    
    const course = $(`#course_${id}`)
    $.ajax({
      url: `/course/${id}/delete/`,  // URL for the AJAX view
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      contentType: 'application/json',
      data: JSON.stringify(data),

      success: function (response) {
        $("#modalContainer").remove()
        course.remove()
        $("#modal-delete-btn").click()
        $(`#coursesContainer`).load(`{% url 'courses:course_create'%} #coursesContainer`)
      },
      error: function (xhr, status, error) {
       
        console.error(error);
      }
    });
  
  
  }

 

  function populateCourses() {
    var categorySelect = document.getElementById("categorySelect");
    var courseSelect = document.getElementById("courseSelect");

    // Clear previous options
    courseSelect.innerHTML = '<option value="">Select...</option>';

    // Get the selected category
    var selectedCategory = categorySelect.value;

    // If a category is selected, populate courses and show the course dropdown
    if (selectedCategory) {

        let data = {
          category: selectedCategory  // Pass the category as data
        }
    
    
        $.ajax({
          url: '/get_course_name/',  // URL for the AJAX view
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          contentType: 'application/json',
          data: JSON.stringify(data),
    
          success: function (response) {
            // Handle the successful response
            var courses = response.courses;
          

                      // Add courses to the dropdown
            courses.forEach(function (course) {
              var option = document.createElement("option");
              option.value = course;
              option.text = course;
              courseSelect.add(option);
            
             
            });
    
          },
          error: function (xhr, status, error) {
            // Handle any error that occurred during the AJAX request
            console.error(error);
          }
        });
      }

      // This is a simple example; you may want to fetch courses dynamically based on the selected category
      var courses;
      courseSelect.style.display = "block";
    } 
  

  function globalDict(key,value) {


  let data = {
    key:key,
    value:value
  }
    $.ajax({
      url: '/user_global_settings_update/',  // URL for the AJAX view
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      contentType: 'application/json',
      data: JSON.stringify(data),

      success: function (response) {
        
          console.log("set successfully");
      },
      error: function (xhr, status, error) {
        // Handle any error that occurred during the AJAX request
        console.error(error);
      }
    });
  
  }


  

  function showCourseModal() {
    var modal = document.getElementById("myModal");
    modal.style.display = "block";
    var selectedCourse = document.getElementById("courseSelect").value;
    document.getElementById("courseName").value = selectedCourse;
    document.body.style.overflow = "hidden";
     globalDict(key = "selectedCourse",value = selectedCourse)
    // Populate modal with existing course details

    const form = document.getElementById("course-form");
    form.addEventListener("submit", function(event) {
      
        event.preventDefault();
        $('body').addClass('loading')
        const formData = new FormData(form);
        const formDataObj = Object.fromEntries(formData.entries());
        let data = {}
        if(formDataObj){
            data = JSON.stringify(formDataObj);
        }
        axios.post("{% url 'courses:course_create'%}", formData, {
          
          headers: {
            'Content-Type': 'application/octet-stream',
            'X-CSRFToken': '{{ csrf_token }}'
          },
       
     
        })
        .then((response) => {
      
          let data = JSON.parse(response.data.response)
          const course = data[0].fields
          //$('body').removeClass('loading')
  
          $(`#coursesContainer`).load(`{% url 'courses:course_create'%} #coursesContainer`)
          document.body.style.overflow = "auto";
        })
        .catch((error) => {
          if(response.errors) {
            const error = document.getElementById("error-container")
            let errorData = JSON.parse(response.errors)

            
            document.body.style.overflow = "auto";
            for (const key in errorData ) {
              const value = errorData[key];
              const element = ` 
              <div class="modal fade" id="errorModal" tabindex="-1" id="my-error-modal" role="dialog" style="position: relative;z-index: 999;">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                        
                            <div class="modal-body">
                                <p id="error-message"> <h1>${key} </h1> ${value}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick = "closeErrorModal()">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `

            error.innerHTML = element
            setTimeout(function(){
              error.innerText = ""
            },3000)
          }
        
        }

     
        });
        
        $.ajax({
          url: "{% url 'courses:course_create'%}",  // URL for the AJAX view
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          data:data,
          //processData: false,
          contentType: false,
   
    
          success: function (response) {
            $("#myModal").remove()
            $("notificationModal").fadeOut(2000)
            showSuccessMessage("success","Course Add","Added successfully",2000)
            $(`#coursesContainer`).load(`{% url 'courses:course_create'%} #coursesContainer`)


          }
       
        });

    })

  }
  


  function showSuccessMessage(icon,title,message,timer) {
    Swal.fire({
      icon: icon,
      title: title,
      text: message,
      confirmButtonColor: "#079a85", // Bootstrap success color
      timer: timer, // Auto-close the popup after 3000 milliseconds (3 seconds)
      showCloseButton: true, // Show close button
    });
  }




  function closeErrorModal(){
    const mymodal = $("#my-error-modal").remove()
      console.log("my modal",mymodal.remove());
   
  }




  function closeModal() {
    var modal = document.getElementById("myModal");
    modal.style.display = "none";
  }
  // Add an event listener to the document body to close the popup when clicked outside

  function findCourseCard(courseName) {

    return courseName
  }

  function saveCourse() {
    var categoryName = document.getElementById("categorySelect").value;
    var courseName = document.getElementById("courseSelect").value;
    var courseDescription =
      document.getElementById("courseDescription").value;
    var coursePictureInput = document.getElementById("coursePicture");
    var coursePicture = coursePictureInput.files[0];

    if (categoryName && courseName && courseDescription) {
      var courseCard = findCourseCard(courseName);

      if (courseCard) {
        // Update existing course card
        var courseDescriptionElement =
          courseCard.querySelector(".courseDescription");
        courseDescriptionElement.innerHTML =
          formatDescription(courseDescription);

        // Update course picture only if a new file is selected
        var courseImage = courseCard.querySelector(".courseImage");
        if (coursePicture) {
          var reader = new FileReader();

          reader.onload = function (e) {
            courseImage.src = e.target.result;
          };

          reader.readAsDataURL(coursePicture);
        }
      } else {
    
          console.log("Please select");
      }

      // Close the modal
      closeModal();
    } else {
      alert("Please enter category, course name, and description.");
    }
  }

  function formatDescription(description) {
    var formattedDescription = "";
    var words = description.split(" ");
    var wordLimit = 15;

    for (var i = 0; i < words.length; i++) {
      var word = words[i];
      if (i >= wordLimit) {
        break;
      }
      if (word.length > 10) {
        // Insert line breaks after every 10 characters
        word = word.replace(/(.{10})/g, "$1<wbr>");
      }
      formattedDescription += word + " ";
    }

    return formattedDescription.trim();
  }
</script>


    <!-- end -->
    <!-- Footer and Dropdwon content  -->
  
    <script>
      // JavaScript to toggle the active class on hamburger click
      document.addEventListener("DOMContentLoaded", function () {
        var navbarHamburger = document.querySelector(".navbar-hamburger");
        var navbarMenu = document.querySelector(".navbar-menu");

        navbarHamburger.addEventListener("click", function () {
          navbarHamburger.classList.toggle("active");
          navbarMenu.classList.toggle("active");
        });

        document.addEventListener("click", function (event) {
          var targetElement = event.target;
          if (
            !targetElement.closest(".navbar") &&
            navbarHamburger.classList.contains("active")
          ) {
            navbarHamburger.classList.remove("active");
            navbarMenu.classList.remove("active");
          }
        });
      });
    </script>
    <!--  -->
    <script>
      // JavaScript to toggle the active class on hamburger click
      document.addEventListener("DOMContentLoaded", function () {
        var navbarHamburger = document.querySelector(".navbar-hamburger");
        var navbarMenu = document.querySelector(".navbar-menu");

        navbarHamburger.addEventListener("click", function () {
          navbarHamburger.classList.toggle("active");
          navbarMenu.classList.toggle("active");
        });

        document.addEventListener("click", function (event) {
          var targetElement = event.target;
          if (
            !targetElement.closest(".navbar") &&
            navbarHamburger.classList.contains("active")
          ) {
            navbarHamburger.classList.remove("active");
            navbarMenu.classList.remove("active");
          }
        });
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>

{% endblock %}
